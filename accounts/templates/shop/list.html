{% extends 'shop/base.html' %}

{% block title %}Loja{% endblock %}

<style>
    .cart-container {
    position: fixed; /* fixo no body/viewport */
    top: 20px;       /* distância do topo */
    right: 20px;     /* distância da direita */
    width: 250px;    /* largura do carrinho */
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;   /* garante que fica acima de outros elementos */
    }
</style>

{% block main %}
<h2 class="hero-section">Produtos Disponíveis</h2>


<!-- Barra de Pesquisa -->
<div style="text-align:center; margin-bottom:20px;">
    <input type="text" id="search-bar" placeholder="Buscar produto..." style="padding:10px; width:60%; max-width:400px; border:1px solid #ccc; border-radius:5px;">
</div>

<div class="product-container" id="product-container">
    {% for product in products %}
    <div class="product-card" data-name="{{ product.name|lower }}">
        {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% endif %}
        <h3>{{ product.name }} - R$ {{ product.price }}</h3>
        <p class="short-desc">{{ product.description|truncatechars:50 }}</p>

        <!-- Botão Ver Mais -->
        <a href="{% url 'detail' product.id %}" class="btn">Ver mais</a>
        <br/>
        <br/>

        <!-- Botão Adicionar ao Carrinho -->
        <button type="button" class="btn add-cart" 
            data-id="{{ product.id }}" 
            data-name="{{ product.name }}" 
            data-price="{{ product.price }}">
            Adicionar
        </button>
    </div>
    {% endfor %}
</div>

<!-- Carrinho -->
<div class="cart-container">
    <h3>Carrinho</h3>
    <ul id="cart-items"></ul>
    <p><strong>Total:</strong> R$ <span id="cart-total">0.00</span></p>
    <button id="finalize-cart" class="btn">Finalizar Pedido</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let cart = [];
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const searchBar = document.getElementById('search-bar');

    function updateCart() {
        cartItems.innerHTML = '';
        let total = 0;
        cart.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name} x ${item.quantity} - R$ ${(item.price * item.quantity).toFixed(2)}`;
            cartItems.appendChild(li);
            total += item.price * item.quantity;
        });
        cartTotal.textContent = total.toFixed(2);
    }

    document.querySelectorAll('.add-cart').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const price = parseFloat(btn.dataset.price);
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({id, name, price, quantity: 1});
            }
            updateCart();

            // Salva o pedido no banco via AJAX
            fetch("{% url 'add_to_cart' 0 %}".replace('0', id), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: 1 })
            }).then(response => response.json())
            .then(data => {
                console.log('Pedido adicionado:', data);
            });
        });
    });

    // Finalizar pedido com checagem de login
    document.getElementById('finalize-cart').addEventListener('click', () => {
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

        if (!isAuthenticated) {
            // Redireciona para login com ?next para voltar depois
            window.location.href = "{% url 'login' %}?next={% url 'list' %}";
        } else {
            alert('Pedidos adicionados com sucesso!');
            // Aqui você pode redirecionar para a página de pedidos ou perfil
            window.location.href = "{% url 'profile' %}";
        }
    });

    // Filtro de pesquisa
    searchBar.addEventListener('keyup', () => {
        const term = searchBar.value.toLowerCase();
        document.querySelectorAll('.product-card').forEach(card => {
            const name = card.getAttribute('data-name');
            if (name.includes(term)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});
</script>

{% endblock %}