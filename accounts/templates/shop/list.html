{% extends 'shop/base.html' %}

{% block title %}Loja{% endblock %}

<style>
/* Estilos gerais */
.hero-section {
    text-align: center;
    margin-bottom: 20px;
}

/* Carrinho lateral */
.cart-container {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100%;
    background: #fff;
    border-left: 2px solid #ccc;
    padding: 20px;
    box-shadow: -4px 0 8px rgba(0,0,0,0.3);
    z-index: 1000;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

.cart-container.active {
    right: 0;
}

.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
}

/* Overlay */
#overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 900;
}

/* Lista de produtos no carrinho */
#cart-items li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.cart-item-controls button {
    margin: 0 4px;
    padding: 4px 8px;
}

/* Produtos da loja */
.product-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
}

.product-card {
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    width: 220px;
    background: #f9f9f9;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.product-card img {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
}
.btn {
    background: #28a745;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
}
.btn:hover {
    background: #218838;
}

/* AnimaÃ§Ã£o do contador */
@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
}
.bounce {
    animation: bounce 0.3s ease;
}
</style>

{% block main %}
<h2 class="hero-section">Produtos DisponÃ­veis</h2>

<!-- Barra de Pesquisa -->
<div style="text-align:center; margin-bottom:20px;">
    <input type="text" id="search-bar" placeholder="Buscar produto..." style="padding:10px; width:60%; max-width:400px; border:1px solid #ccc; border-radius:5px;">
</div>

<!-- Lista de Produtos -->
<div class="product-container" id="product-container">
    {% for product in products %}
    <div class="product-card" data-name="{{ product.name|lower }}">
        {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% endif %}
        <h3>{{ product.name }} - R$ {{ product.price }}</h3>
        <p class="short-desc">{{ product.description|truncatechars:50 }}</p>
        <a href="{% url 'detail' product.id %}" class="btn">Ver mais</a>
        <br><br>
        <button type="button" class="btn add-cart" 
            data-id="{{ product.id }}" 
            data-name="{{ product.name }}" 
            data-price="{{ product.price }}">
            Adicionar
        </button>
    </div>
    {% endfor %}
</div>

<!-- BotÃ£o Carrinho -->
<button id="toggle-cart" class="btn" style="position:fixed; top:20px; right:20px; z-index:1100;">
    ðŸ›’ Carrinho (<span id="cart-count">0</span>)
</button>

<!-- Overlay -->
<div id="overlay"></div>

<!-- Carrinho -->
<div id="cart-container" class="cart-container">
    <div class="cart-header">
        <h3>Carrinho</h3>
        <button id="close-cart" class="close-btn">âœ–</button>
    </div>
    <ul id="cart-items"></ul>
    <p><strong>Total:</strong> R$ <span id="cart-total">0.00</span></p>
    <button id="finalize-cart" class="btn">Finalizar Pedido</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const cartCount = document.getElementById('cart-count');
    const searchBar = document.getElementById('search-bar');
    const cartContainer = document.getElementById('cart-container');
    const overlay = document.getElementById('overlay');
    const toggleCartBtn = document.getElementById('toggle-cart');
    const closeCartBtn = document.getElementById('close-cart');

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    function updateCart() {
        cartItems.innerHTML = '';
        let total = 0;
        let quantitySum = 0;

        cart.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${item.name} - R$ ${(item.price * item.quantity).toFixed(2)}</span>
                <div class="cart-item-controls">
                    <button class="decrease">-</button>
                    <span>${item.quantity}</span>
                    <button class="increase">+</button>
                    <button class="remove">x</button>
                </div>
            `;

            // AÃ§Ãµes de aumentar, diminuir, remover
            li.querySelector('.increase').addEventListener('click', () => {
                item.quantity++;
                updateCart();
            });
            li.querySelector('.decrease').addEventListener('click', () => {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    cart = cart.filter(i => i.id !== item.id);
                }
                updateCart();
            });
            li.querySelector('.remove').addEventListener('click', () => {
                cart = cart.filter(i => i.id !== item.id);
                updateCart();
            });

            cartItems.appendChild(li);
            total += item.price * item.quantity;
            quantitySum += item.quantity;
        });

        cartTotal.textContent = total.toFixed(2);
        cartCount.textContent = quantitySum;
        cartCount.classList.add('bounce');
        setTimeout(() => cartCount.classList.remove('bounce'), 300);

        saveCart();
    }

    // Inicializa carrinho salvo
    updateCart();

    // Mostrar carrinho
    toggleCartBtn.addEventListener('click', () => {
        cartContainer.classList.add('active');
        overlay.style.display = 'block';
    });

    // Fechar carrinho
    function closeCart() {
        cartContainer.classList.remove('active');
        overlay.style.display = 'none';
    }
    closeCartBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', closeCart);

    // Adicionar produto ao carrinho
    document.querySelectorAll('.add-cart').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const price = parseFloat(btn.dataset.price);
            const existing = cart.find(item => item.id === id);

            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, name, price, quantity: 1 });
            }

            updateCart();

            // Salvar no backend via AJAX
            fetch("{% url 'add_to_cart' 0 %}".replace('0', id), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: 1 })
            }).then(response => response.json())
            .then(data => console.log('Pedido adicionado:', data));
        });
    });

    // Finalizar pedido com checagem de login
    document.getElementById('finalize-cart').addEventListener('click', () => {
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        if (!isAuthenticated) {
            window.location.href = "{% url 'login' %}?next={% url 'list' %}";
        } else {
            alert('Pedidos adicionados com sucesso!');
            window.location.href = "{% url 'profile' %}";
        }
    });

    // Filtro de pesquisa
    searchBar.addEventListener('keyup', () => {
        const term = searchBar.value.toLowerCase();
        document.querySelectorAll('.product-card').forEach(card => {
            const name = card.getAttribute('data-name');
            card.style.display = name.includes(term) ? 'block' : 'none';
        });
    });
});
</script>

{% endblock %}
